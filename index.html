<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"
    />
    <title>Большой тест</title>
    <style>
      /* Base styles */
      :root {
        --primary-color: #4caf50;
        --secondary-color: #2196f3;
        --error-color: #f44336;
        --text-color: #333;
      }

      .timer {
        display: none;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        color: var(--text-color);
        max-width: 1000px;
        margin: 0 auto;
      }

      /* Sections */
      .section {
        display: none;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin: 20px 0;
      }

      .section.active {
        display: block;
      }

      /* Buttons */
      .button-group {
        margin-top: 30px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      button {
        background-color: var(--primary-color);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        flex: 1;
      }

      button:hover {
        background-color: #45a049;
      }

      button.secondary {
        background-color: var(--secondary-color);
      }

      /* Images */
      .image-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      .image-grid img {
        width: 170px; /* По умолчанию будет как у главной картинки */
        max-width: 180%; /* Ориентируемся на размер .big-image */
        cursor: pointer;
        border: 1px solid #999;
        transition: all 0.3s ease;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        flex-shrink: 0;
        user-select: none;
      }
      /*  */
      .image-grid img:hover {
        filter: brightness(85%); /* Затемнение на 15% при наведении */
        border: 1px solid #666; /* Более заметная граница */
      }
      /* Главная картинка */
      .big-image {
        max-width: 300px;
        width: 100%;
        margin: 20px auto;
        display: block;
        min-height: 229px;
      }

      /* Если экран меньше 768px (планшеты и телефоны), уменьшаем картинки-варианты */
      @media (max-width: 768px) {
        .image-grid img {
          width: 18%;
          max-width: 80px;
        }
      }

      .radio-group {
        margin: 20px 0;
      }

      .radio-group label {
        display: block;
        margin: 10px 0;
        padding: 10px;
        background: #f8f8f8;
        border-radius: 4px;
      }

      /* Progress */
      .progress {
        width: 100%;
        height: 8px;
        background: #eee;
        border-radius: 4px;
        margin: 20px 0;
      }

      .progress-bar {
        height: 100%;
        background: var(--secondary-color);
        border-radius: 4px;
        transition: width 0.3s;
      }

      /* Timer */
      .timer {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #fff;
        padding: 8px 16px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Mobile styles */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .image-grid img {
          width: 50%;
        }

        button {
          width: 100%;
        }

        .timer {
          top: auto;
          bottom: 10px;
          right: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Изменён текст таймера -->
    <div class="timer" id="timer">Время теста: 0 сек</div>
    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Section 1: Welcome -->
    <div class="section active" id="section1">
      <h1>Опрос</h1>
      <p>
        Здравствуйте! Приглашаем Вас принять участие в опросе. Опрос состоит из
        нескольких разделов. Среднее время заполнения — 10-15 минут. Ваше
        участие очень важно для нас! Благодарим за внимание и участие!
      </p>
      <div class="button-group">
        <button onclick="goToSection(2)">Начать</button>
      </div>
    </div>

    <!-- Section 2: General questions -->
    <div class="section" id="section2">
      <h2>Общие вопросы</h2>
      <label>
        Укажите Ваш возраст:
        <input type="number" id="age" min="1" max="120" />
      </label>

      <div class="radio-group">
        <p>Укажите Ваш биологический пол:</p>
        <label><input type="radio" name="gender" value="м" /> Мужской</label>
        <label><input type="radio" name="gender" value="ж" /> Женский</label>
      </div>

      <div class="radio-group">
        <p>Укажите Ваш уровень образования:</p>
        <label
          ><input type="radio" name="education" value="Среднее" /> Среднее
          образование</label
        >
        <label
          ><input type="radio" name="education" value="Среднее специальное" />
          Среднее специальное</label
        >
        <label
          ><input type="radio" name="education" value="Студент" />
          Студент</label
        >
        <label
          ><input type="radio" name="education" value="Высшее" /> Высшее
          образование</label
        >
      </div>

      <div class="button-group">
        <button class="secondary" onclick="goToSection(1)">Назад</button>
        <button onclick="saveSection2()">Далее</button>
      </div>
    </div>

    <!-- Section 3: Figures test instruction -->
    <div class="section" id="section3">
      <h2>Тест включённых фигур</h2>
      <p>ИНСТРУКЦИЯ:</p>
      <p>
        Вам будут предъявлены сложные фигуры (изображения), в каждой из которых
        имеется один из простых эталонов. Вы должны найти в каждом случае, какой
        из этих элементов содержится в рисунке, и указать его.
      </p>
      <p></p>
      <p>В каждом сложном рисунке имеется один из следующих элементов:</p>
      <div class="example-images">
        <img
          src="images/1.1.jpg"
          style="width: 90px"
        />
        <img
          src="images/1.2.jpg"
          style="width: 90px"
        />
        <img
          src="images/1.3.jpg"
          style="width: 90px"
        />
        <img
          src="images/1.4.jpg"
          style="width: 90px"
        />
        <img
          src="images/1.5.jpg"
          style="width: 90px"
        />
      </div>
      <p>
        Укажите в каждом случае, какой из этих элементов содержится в рисунке.
        Например:
      </p>
      <img
        src="images/primer.jpg"
        style="width: 170px"
      />
      <p>Помните:</p>
      <p></p>
      <p>
        • В каждом рисунке имеется один из элементов приблизительно той же
        величины(*) и так же расположенный, как на образце.
      </p>
      <p>• В каждом рисунке имеется только один из элементов.</p>
      <p>• Время выполнения теста учитывается при расчете результата.</p>
      <p>
        (*) При прохождении теста на мобильных устройствах размеры образцов
        будут меньше, чем на фигуре.
      </p>
      <div class="button-group">
        <button class="secondary" onclick="goToSection(2)">Назад</button>
        <button onclick="goToSection(4)">Начать тест</button>
      </div>
    </div>

    <!-- Section 4: Figures test -->
    <div class="section" id="section4">
      <h2>Тест включённых фигур <span id="currentFigure"></span></h2>
      <div id="figureTestContainer"></div>
      <!-- <div class="button-group">
        <button class="secondary" onclick="goToSection(3)">Назад</button>
        <button id="nextFigureButton" onclick="nextFigure()" disabled>
          Далее
        </button>
      </div> -->
    </div>

    <!-- Section 5: Art rating instruction -->
    <div class="section" id="section5">
      <h2>Оценка произведений искусства</h2>
      <p>
        Вам будут предъявлены 6 картин, и вам нужно будет оценить их стоимость
        по шкале от 1 (очень дешево) до 10 (очень дорого).
      </p>
      <p></p>
      <div id="artInstructionImages"></div>
      <div class="button-group">
        <button onclick="startArtRatingTest()">Начать</button>
      </div>
    </div>

    <!-- Section 6: Art rating -->
    <div class="section" id="section6">
      <h2>Оценка картины <span id="currentArt"></span></h2>
      <div id="artRatingContainer"></div>
      <div class="button-group">
        <button class="secondary" onclick="goToSection(5)">Назад</button>
        <button id="nextArtButton" onclick="nextArt()" disabled>Далее</button>
      </div>
    </div>

    <!-- Section 7: Completion -->
    <div class="section" id="section7">
      <h2>Опрос завершён!</h2>
      <p>Спасибо за Ваше участие! Ваши ответы были сохранены.</p>
      <div class="button-group">
        <button onclick="location.reload()">Начать заново</button>
      </div>
    </div>

    <script>
      // Обновлённое состояние
      const state = {
        currentSection: 1,
        figuresTimerInterval: null, // Только для таймера фигур
        timeSpentFigures: 0, // Новое поле для времени фигур
        surveyData: {
          age: "",
          gender: "",
          education: "",
          showArtInstructionImage: null,
          figuresAnswers: [],
          artRatings: [],
        },
      };

      // Загрузка состояния из localStorage
      function loadState() {
        const saved = localStorage.getItem("surveyState");
        if (saved) {
          const savedState = JSON.parse(saved);
          state.surveyData = savedState.surveyData;
          state.timeSpentFigures = savedState.timeSpentFigures || 0;
          state.currentSection = savedState.currentSection;
          // if (state.currentSection === 4) {
          //   startFiguresTest();
          // }
          if (typeof state.timeSpentFigures === "number") {
            document.getElementById(
              "timer"
            ).textContent = `Время теста: ${state.timeSpentFigures} сек`;
          }
        }
        updateProgress();
      }

      // Сохранение состояния
      function saveState() {
        const stateToSave = { ...state };
        delete stateToSave.figuresTimerInterval;
        localStorage.setItem("surveyState", JSON.stringify(stateToSave));
      }

      // При загрузке секции вызывается из goTosection
      const sectionsHooks = {
        section5: () => {
          showPrimingImages();
        },
        section4: () => {
          const _figuresAnswers = state.surveyData.figuresAnswers;
          if (_figuresAnswers && _figuresAnswers.length > 0) {
            currentFigureIndex = _figuresAnswers.length - 1;
          }
          startFiguresTest();
        },
      };

      // Навигация
      function goToSection(num) {
        state.currentSection = num;
        document
          .querySelectorAll(".section")
          .forEach((sec) => sec.classList.remove("active"));
        document.getElementById(`section${num}`).classList.add("active");
        updateProgress();
        const onLoad = sectionsHooks[`section${num}`];
        if (typeof onLoad === "function") {
          onLoad();
        }
        //
        saveState();
      }

      // Прогресс-бар
      function updateProgress() {
        const totalSections = 6;
        const progress = ((state.currentSection - 1) / totalSections) * 100;
        document.getElementById("progressBar").style.width = `${progress}%`;
      }

      // Логика раздела 2
      function saveSection2() {
        state.surveyData.age = document.getElementById("age").value;
        state.surveyData.gender = document.querySelector(
          'input[name="gender"]:checked'
        )?.value;
        state.surveyData.education = document.querySelector(
          'input[name="education"]:checked'
        )?.value;
        if (
          !state.surveyData.age ||
          !state.surveyData.gender ||
          !state.surveyData.education
        ) {
          alert("Заполните все поля для продолжения");
          return;
        }
        goToSection(3);
      }

      const IMAGES_COUNT = 30;

      // Данные для теста фигур
      // const figureTestData = [
      //   {
      //     id: 1,
      //     bigImage: "images/1.jpg",
      //     options: [
      //       "images/1.1.jpg",
      //       "images/1.2.jpg",
      //       "images/1.3.jpg",
      //       "images/1.4.jpg",
      //       "images/1.5.jpg",
      //     ],
      //   },
      // ];
      function generateFiguresTestData() {
        let result = [];
        for (let index = 0; index < IMAGES_COUNT; index++) {
          // const element = array[index];
          result.push({
            id: index + 1,
            bigImage: `images/${index + 1}.jpg`,
            options: [
              "images/1.1.jpg",
              "images/1.2.jpg",
              "images/1.3.jpg",
              "images/1.4.jpg",
              "images/1.5.jpg",
            ],
          });
        }
        return result;
      }

      const figureTestData = generateFiguresTestData();
      let currentFigureIndex = 0;

      function startFiguresTest() {
        // Сброс и запуск таймера фигур
        if (typeof state.timeSpentFigures !== 'number') {
          state.timeSpentFigures = 0;
        }
        
        // Обновление таймера каждую секунду
        if (!state.figuresTimerInterval) {
          state.figuresTimerInterval = setInterval(() => {
            state.timeSpentFigures++;
            document.getElementById(
              "timer"
            ).textContent = `Время теста: ${state.timeSpentFigures} сек`;
            saveState();
          }, 1000);
        }
        renderFigure();
      }

      function renderFigure() {
        const container = document.getElementById("figureTestContainer");
        const current = figureTestData[currentFigureIndex];

        container.innerHTML = `
        <p>Вопрос: ${currentFigureIndex + 1} из ${figureTestData.length}</p>
        <img src="${current.bigImage}" draggable="false" class="big-image">
        <div class="image-grid">
          ${current.options
            .map(
              (src, i) =>
                `<img src="${src}" draggable="false" onclick="selectFigure(${i})" ${
                  state.surveyData.figuresAnswers[currentFigureIndex] === i
                    ? 'class="selected"'
                    : ""
                }>`
            )
            .join("")}
        </div>
      `;

        document.getElementById("currentFigure").textContent = ``; // Убираем "1/1" сверху
      }

      function selectFigure(index) {
        state.surveyData.figuresAnswers[currentFigureIndex] = index + 1;
        saveState(); // Сохраняем выбор

        // Если есть ещё фигуры — идём дальше, иначе переходим к следующему разделу
        if (currentFigureIndex < figureTestData.length - 1) {
          currentFigureIndex++;
          renderFigure();
        } else {
          clearInterval(state.figuresTimerInterval); // Останавливаем таймер
          state.figuresTimerInterval = null;
          goToSection(5); // Переход к следующему разделу
        }
      }

      // Логика оценки произведений искусства
      const artData = [
        { id: 1, src: "images/1p.jpg" },
        { id: 2, src: "images/2p.jpg" },
        { id: 3, src: "images/3p.jpg" },
        { id: 4, src: "images/4p.jpg" },
        { id: 5, src: "images/5p.jpg" },
        { id: 6, src: "images/6p.jpg" },
      ];

      let currentArtIndex = 0;

      function showPrimingImages() {
        if (typeof state.surveyData.showArtInstructionImage !== "boolean") {
          state.surveyData.showArtInstructionImage = Math.random() < 0.5;
          saveState();
        }

        if (state.surveyData.showArtInstructionImage) {
          document.getElementById("artInstructionImages").innerHTML = `
          <img src="images/car.jpg" class="big-image" style="display: inline-block;">
          <img src="images/shop.jpg" class="big-image" style="display: inline-block;">
        `;
        } else {
          document.getElementById("artInstructionImages").innerHTML = "";
        }
      }
      function startArtRatingTest() {
        saveState();
        goToSection(6);
        renderArt(); // ВАЖНО: вызываем, чтобы сразу показать первую картину
      }

      // function startArtRatingTest() {
      //   state.surveyData.showArtInstructionImage = Math.random() < 0.5;

      //   if (state.surveyData.showArtInstructionImage) {
      //     document.getElementById("artInstructionImages").innerHTML = `
      //     <img src="images/car.jpg" class="big-image">
      //     <img src="images/shop.jpg" class="big-image">
      //   `;
      //   } else {
      //     document.getElementById("artInstructionImages").innerHTML = "";
      //   }

      //   saveState(); // Сохраняем обновлённое значение
      //   goToSection(6);
      //   renderArt(); // ВАЖНО: вызываем, чтобы сразу показать первую картину
      // }

      function renderArt() {
        const container = document.getElementById("artRatingContainer");
        const current = artData[currentArtIndex];

        container.innerHTML = `
        <p>Картина: ${currentArtIndex + 1} из ${artData.length}</p>
        <img src="${current.src}" class="big-image">
        <div class="radio-group">
          ${Array.from(
            { length: 10 },
            (_, i) =>
              `<label>
              <input type="radio" name="artRating" value="${i + 1}" ${
                state.surveyData.artRatings[currentArtIndex] === i + 1
                  ? "checked"
                  : ""
              } onchange="selectRating(${i + 1})">
              ${i + 1}
            </label>`
          ).join("")}
        </div>
      `;

        document.getElementById("nextArtButton").disabled =
          state.surveyData.artRatings[currentArtIndex] === undefined;
      }

      function selectRating(rating) {
        state.surveyData.artRatings[currentArtIndex] = rating;
        document.getElementById("nextArtButton").disabled = false;
        saveState();
      }

      function nextArt() {
        if (currentArtIndex < artData.length - 1) {
          currentArtIndex++;
          renderArt();
        } else {
          submitData();
          goToSection(7);
          localStorage.removeItem("surveyState");
        }
      }

      // Отправка данных
    
      // Функция для отправки данных
    async function submitData() {
      const surveyData = {
        ...state.surveyData,
        figuresTimeSec: state.timeSpentFigures
      };
    
      console.log("Отправляемые данные:", JSON.stringify(surveyData));
    
      try {
        const response = await fetch("/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(surveyData),
        });
    
        if (response.ok) {
          console.log("Данные успешно отправлены!");
        } else {
          console.error("Ошибка при отправке данных.");
        }
      } catch (error) {
        console.error("Ошибка:", error);
      }
    }

      // Инициализация
      window.addEventListener("load", () => {
        // console.log(figureTestData);
        loadState();
        goToSection(state.currentSection);
      });
    </script>
  </body>
</html>

  
